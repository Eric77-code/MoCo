<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>農產品交易行情儀表板（純 JS - 簡化版）</title>
  </head>

  <body>
    <h1>農產品交易行情儀表板（純 JavaScript）</h1>

    <h2>查詢條件</h2>

    <div>
      <label>作物名稱：
        <input id="cropName" placeholder="輸入關鍵字，例：豆" />
      </label>
    </div>

    <div>
      <label>交易日期(起) 民國：
        <input id="startDate" placeholder="例：115.01.10" />
      </label>
    </div>

    <div>
      <label>交易日期(訖) 民國：
        <input id="endDate" placeholder="例：115.01.10" />
      </label>
    </div>

    <div>提示：查詢區間範圍三天內（含今日）</div>

    <div>
      <button id="locBtn">取得定位（找最近市場）</button>
      <button id="queryBtn">查詢</button>
    </div>

    <div id="locMsg"></div>

    <h3>市場（手動選擇）</h3>
    <div>
      <select id="marketSelect"></select>
    </div>
    <div id="marketsInfo"></div>

    <hr />

    <div id="errorBox"></div>

    <h2>KPI</h2>
    <div id="kpiArea">
      <div id="kpi1">最新均價：—</div>
      <div id="kpi2">最新交易量：—</div>
      <div id="kpi3">區間均價（加權）：—</div>
      <div id="kpi4">區間總量：—</div>
    </div>

    <hr />

    <h2>行情明細</h2>
    <div id="tableHint">尚無資料（請先查詢）。</div>
    <table border="1" cellpadding="6" cellspacing="0">
      <thead>
        <tr>
          <th>日期</th>
          <th>作物</th>
          <th>市場</th>
          <th>上 / 中 / 下 / 平均</th>
          <th>交易量</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <script>
// ===== 市場清單與座標（省略部分重複清單以保持長度，邏輯不變） =====
const ALL_MARKETS = [
  { marketId: "104", marketName: "台北二" }, { marketId: "109", marketName: "台北一" },
  { marketId: "220", marketName: "板橋區" }, { marketId: "241", marketName: "三重區" },
  { marketId: "260", marketName: "宜蘭市" }, { marketId: "400", marketName: "台中市" },
  { marketId: "514", marketName: "溪湖鎮" }, { marketId: "600", marketName: "嘉義市" },
  { marketId: "700", marketName: "台南市場" }, { marketId: "800", marketName: "高雄市" },
  { marketId: "900", marketName: "屏東市" }, { marketId: "950", marketName: "花蓮市" },
  { marketId: "423", marketName: "東勢鎮" }, { marketId: "105", marketName: "台北市場" },
  { marketId: "338", marketName: "桃農" }, { marketId: "420", marketName: "豐原區" },
  { marketId: "540", marketName: "南投市" }, { marketId: "830", marketName: "鳳山區" },
  { marketId: "512", marketName: "永靖鄉" }, { marketId: "648", marketName: "西螺鎮" },
];

const MARKET_LOCATIONS = [
  { marketId: "104", marketName: "台北二", lat: 25.062361, lng: 121.511934 },
  { marketId: "109", marketName: "台北一", lat: 25.0452, lng: 121.5076 },
  { marketId: "220", marketName: "板橋區", lat: 25.0113, lng: 121.4625 },
  { marketId: "241", marketName: "三重區", lat: 25.0632, lng: 121.4889 },
  { marketId: "260", marketName: "宜蘭市", lat: 24.7571, lng: 121.7537 },
  { marketId: "400", marketName: "台中市", lat: 24.1442, lng: 120.6816 },
  { marketId: "514", marketName: "溪湖鎮", lat: 23.957942, lng: 120.485691 },
  { marketId: "648", marketName: "西螺鎮", lat: 23.784121, lng: 120.448110 },
  { marketId: "700", marketName: "台南市場", lat: 22.9972, lng: 120.2123 },
  { marketId: "800", marketName: "高雄市", lat: 22.6346, lng: 120.3081 },
  { marketId: "900", marketName: "屏東市", lat: 22.6690, lng: 120.4864 },
  { marketId: "930", marketName: "台東市", lat: 22.7554, lng: 121.15 },
  { marketId: "950", marketName: "花蓮市", lat: 23.9872, lng: 121.6015 },
];

const MOA_URL = "https://data.moa.gov.tw/Service/OpenData/FromM/FarmTransData.aspx";

// ===== DOM =====
const $ = (id) => document.getElementById(id);
const elCrop = $("cropName"), elStart = $("startDate"), elEnd = $("endDate");
const elMarket = $("marketSelect"), elMarketsInfo = $("marketsInfo");
const elLocBtn = $("locBtn"), elQueryBtn = $("queryBtn"), elLocMsg = $("locMsg");
const elError = $("errorBox"), elTbody = $("tbody"), elTableHint = $("tableHint");
const elKpi1 = $("kpi1"), elKpi2 = $("kpi2"), elKpi3 = $("kpi3"), elKpi4 = $("kpi4");

const state = {
  filters: { cropName: "花椰菜-青梗", startDateRoc: todayRoc(), endDateRoc: todayRoc(), marketId: "", marketName: "" },
  rows: [], locating: false,
};

init();

function init() {
  elCrop.value = state.filters.cropName;
  elStart.value = state.filters.startDateRoc;
  elEnd.value = state.filters.endDateRoc;
  renderMarketSelect();
  renderMarketsInfo();

  elCrop.addEventListener("input", (e) => state.filters.cropName = e.target.value.trim());
  elStart.addEventListener("input", (e) => state.filters.startDateRoc = e.target.value.trim());
  elEnd.addEventListener("input", (e) => state.filters.endDateRoc = e.target.value.trim());
  elMarket.addEventListener("change", (e) => {
    const id = e.target.value;
    const m = ALL_MARKETS.find((x) => x.marketId === id);
    state.filters.marketId = id;
    state.filters.marketName = m ? m.marketName : "";
    elLocMsg.textContent = "";
    renderMarketsInfo();
  });
  elLocBtn.addEventListener("click", handleLocate);
  elQueryBtn.addEventListener("click", handleQuery);
  resetOutputs();
}

function renderMarketSelect() {
  elMarket.innerHTML = '<option value="">（不選市場）</option>';
  for (const m of ALL_MARKETS) {
    const opt = document.createElement("option");
    opt.value = m.marketId;
    opt.textContent = `${m.marketName}（${m.marketId}）`;
    elMarket.appendChild(opt);
  }
}

function renderMarketsInfo() {
  const id = state.filters.marketId;
  elMarketsInfo.textContent = `市場數：${ALL_MARKETS.length}｜目前市場：` + (id ? `${state.filters.marketName}（${id}）` : "未指定");
}

// ===== 定位邏輯 (簡化) =====
async function handleLocate() {
  if (state.locating || !navigator.geolocation) return;
  state.locating = true; elLocBtn.disabled = true; elLocBtn.textContent = "定位中…";
  try {
    const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej));
    const best = nearestMarket(pos.coords.latitude, pos.coords.longitude);
    if (best) {
      state.filters.marketId = best.marketId;
      state.filters.marketName = best.marketName;
      elMarket.value = best.marketId;
      elLocMsg.textContent = `已定位最近市場：${best.marketName}`;
      renderMarketsInfo();
    }
  } catch { elLocMsg.textContent = "定位失敗，請手動選擇。"; }
  finally { state.locating = false; elLocBtn.disabled = false; elLocBtn.textContent = "取得定位（找最近市場）"; }
}

function nearestMarket(lat, lng) {
  let best = null;
  for (const m of MARKET_LOCATIONS) {
    const d = haversineKm({ lat, lng }, { lat: m.lat, lng: m.lng });
    if (!best || d < best.distanceKm) best = { ...m, distanceKm: d };
  }
  return best;
}

// ===== 查詢與篩選 (模糊搜尋重點) =====
async function handleQuery() {
  elError.textContent = "查詢中…";
  resetOutputs();
  try {
    const allRows = await fetchFarmTransData({ startDateRoc: state.filters.startDateRoc, endDateRoc: state.filters.endDateRoc });
    state.rows = filterRows(allRows, state.filters);
    elError.textContent = state.rows.length ? "" : "提示：查無資料。";
    renderAll();
  } catch { elError.textContent = "錯誤：取得行情失敗"; }
}

async function fetchFarmTransData(params) {
  const all = [];
  for (let page = 0; page < 4; page++) {
    const u = new URL(MOA_URL);
    u.searchParams.set("FOTT", "JSON");
    u.searchParams.set("IsTransData", "1");
    u.searchParams.set("UnitId", "037");
    u.searchParams.set("$top", "3000");
    u.searchParams.set("$skip", String(page * 3000));
    u.searchParams.set("StartDate", params.startDateRoc);
    u.searchParams.set("EndDate", params.endDateRoc);
    const res = await fetch(u.toString());
    const raw = await res.json();
    for (const r of raw) all.push(normalizeRow(r));
    if (raw.length < 3000) break;
  }
  return all;
}

function filterRows(rows, filters) {
  const keyword = (filters.cropName || "").trim();
  const mid = (filters.marketId || "").trim();
  return rows.filter((r) => {
    const okCrop = keyword === "" ? true : (r.cropName && r.cropName.includes(keyword));
    const okMid = mid === "" ? true : (r.marketId === mid);
    return okCrop && okMid;
  });
}

function normalizeRow(raw) {
  return {
    date: rocToIso(String(raw["交易日期"] || "").trim()),
    cropName: String(raw["作物名稱"] || "").trim(),
    marketId: String(raw["市場代號"] || "").trim(),
    marketName: String(raw["市場名稱"] || "").trim(),
    high: toNumberOrNull(raw["上價(元_公斤)"] ?? raw["上價"]),
    mid: toNumberOrNull(raw["中價(元_公斤)"] ?? raw["中價"]),
    low: toNumberOrNull(raw["下價(元_公斤)"] ?? raw["下價"]),
    avg: toNumberOrNull(raw["平均價(元_公斤)"] ?? raw["平均價"]),
    volume: toNumberOrNull(raw["交易量(公斤)"] ?? raw["交易量"]),
  };
}

function toNumberOrNull(v) {
  if (v == null) return null;
  const n = Number(String(v).trim().replace(/,/g, ""));
  return isFinite(n) ? n : null;
}

// ===== KPI 與 表格 =====
function resetOutputs() {
  elKpi1.textContent = elKpi2.textContent = elKpi3.textContent = elKpi4.textContent = "—";
  elTableHint.textContent = "尚無資料。"; elTbody.innerHTML = "";
}

function renderAll() {
  renderKpis();
  renderTable();
}

function renderKpis() {
  if (!state.rows.length) return;
  const rows = state.rows;
  const latestDate = [...new Set(rows.map(r => r.date))].sort().at(-1);
  const latestRows = rows.filter(r => r.date === latestDate);
  const avgP = latestRows.reduce((sum, r) => sum + (r.avg || 0), 0) / latestRows.length;
  const totalV = latestRows.reduce((sum, r) => sum + (r.volume || 0), 0);
  let wSum = 0, vSum = 0;
  rows.forEach(r => { if(r.avg && r.volume) { wSum += r.avg * r.volume; vSum += r.volume; } });

  elKpi1.textContent = `最新均價（${latestDate}）：${fmt(avgP, 1)} 元`;
  elKpi2.textContent = `最新量：${fmtInt(totalV)} 公斤`;
  elKpi3.textContent = `區間加權均價：${fmt(vSum ? wSum/vSum : 0, 1)} 元`;
  elKpi4.textContent = `區間總量：${fmtInt(vSum)} 公斤`;
}

function renderTable() {
  if (!state.rows.length) return;
  elTableHint.textContent = "";
  elTbody.innerHTML = state.rows.map(r => `
    <tr>
      <td>${r.date}</td><td>${r.cropName}</td><td>${r.marketName}</td>
      <td>${fmt(r.high,1)} / ${fmt(r.mid,1)} / ${fmt(r.low,1)} / ${fmt(r.avg,1)}</td>
      <td>${fmtInt(r.volume)}</td>
    </tr>`).join('');
}

// ===== 工具函式 =====
function todayRoc() {
  const d = new Date();
  return `${d.getFullYear()-1911}.${String(d.getMonth()+1).padStart(2,"0")}.${String(d.getDate()).padStart(2,"0")}`;
}
function rocToIso(roc) {
  const p = roc.split(".");
  return p.length !== 3 ? roc : `${Number(p[0])+1911}-${p[1]}-${p[2]}`;
}
function haversineKm(a, b) {
  const R = 6371, dLat = (b.lat-a.lat)*Math.PI/180, dLng = (b.lng-a.lng)*Math.PI/180;
  const s = Math.sin(dLat/2)**2 + Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dLng/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(s), Math.sqrt(1-s));
}
function fmt(n, d) { return n == null ? "—" : n.toFixed(d); }
function fmtInt(n) { return n == null ? "—" : Math.round(n).toLocaleString(); }
    </script>
  </body>
</html>
